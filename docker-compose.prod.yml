services:
  backend:
    build:
      context: .
      dockerfile_inline: |
        FROM node:20-alpine AS builder
        RUN apk add --no-cache openssl
        WORKDIR /app
        RUN corepack enable && corepack prepare pnpm@latest --activate
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY back/package.json ./back/
        COPY back/prisma ./back/prisma/
        RUN pnpm install --frozen-lockfile
        COPY back ./back
        WORKDIR /app/back
        RUN npx prisma generate
        RUN pnpm build

        FROM node:20-alpine
        RUN apk add --no-cache openssl
        WORKDIR /app
        RUN corepack enable && corepack prepare pnpm@latest --activate
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY back/package.json ./back/
        COPY back/prisma ./back/prisma/
        RUN pnpm install --frozen-lockfile --prod
        WORKDIR /app/back
        RUN npx prisma generate
        COPY --from=builder /app/back/dist ./dist
        RUN mkdir -p public
        EXPOSE 3001
        CMD sh -c "npx prisma migrate deploy && node dist/main"
    container_name: obedi-backend
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql://postgres:t5w0hkaslhidtc5v@146.103.126.232:5432/postgres
      - REDIS_URL=redis://default:s1yzhzyfjbdzswcl@146.103.126.232:6379
      - JWT_SECRET=fLEjUhS/OAR4c9jssc4TITf77xz1maiI9vrDfNhWzxc=
      - JWT_EXPIRES_IN=15m
      - JWT_REFRESH_EXPIRES_IN=7d
      - SUPABASE_URL=https://lkzlaoffbljsvqvedryq.supabase.co
      - SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxremxhb2ZmYmxqc3ZxdmVkcnlxIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjY2MTg5OCwiZXhwIjoyMDgyMjM3ODk4fQ.M6BS6EiuHigTg3ec36hIwzJPbNcJW1U8j8PVXRDSydE
      - SUPABASE_BUCKET=lunches
      - PORT=3001
      - FRONTEND_URL=http://asd-mono-xnm0rz-29763f-146-103-126-232.traefik.me
    ports:
      - "3001:3001"
    networks:
      - obedi-network

  frontend:
    build:
      context: .
      dockerfile_inline: |
        FROM node:20-alpine AS builder
        WORKDIR /app
        RUN corepack enable && corepack prepare pnpm@latest --activate
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY front/package.json ./front/
        RUN pnpm install --frozen-lockfile
        COPY front ./front
        WORKDIR /app/front
        RUN pnpm build

        FROM nginx:alpine
        COPY --from=builder /app/front/dist /usr/share/nginx/html
        RUN echo 'server { \
            listen 80; \
            server_name _; \
            root /usr/share/nginx/html; \
            index index.html; \
            client_max_body_size 10M; \
            gzip on; \
            gzip_types text/plain text/css application/json application/javascript text/xml application/xml; \
            location /api/ { \
                proxy_pass http://backend:3001; \
                proxy_http_version 1.1; \
                proxy_set_header Host $$host; \
                proxy_set_header X-Real-IP $$remote_addr; \
            } \
            location / { \
                try_files $$uri $$uri/ /index.html; \
            } \
        }' > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
    container_name: obedi-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    networks:
      - obedi-network
    depends_on:
      - backend

networks:
  obedi-network:
    driver: bridge
